from utils import get_files
import re
import string



import openai
import pandas as pd



def is_whitespace_or_punctuation(char):
    return  char.isspace()  or  char in string.punctuation or char in ['，','。','、','；','：','「','」','『','』','（','）','《','》','？','！','“','”','‘','’','—','…','．','～','〈','〉','﹑','﹔','﹕','﹖','﹗','﹘','﹙','﹚','﹛','﹜','﹝','﹞','﹟','﹠','﹡','﹢','﹣','﹤','﹥','﹦','﹨','﹩','﹪','﹫','！','？','；','：','、','，','。','．','〈','〉','《','》','「','」','『','』','（','）','［','］','｛','｝','【','】','—','…','～','﹏','﹋','﹌','﹍','﹎','﹏','﹐','﹑','﹒','﹔','﹕','﹖','﹗','﹘','﹙','﹚','﹛','﹜','﹝','﹞','﹟','﹠','﹡','﹢','﹣','﹤','﹥','﹦','﹨','﹩','﹪','﹫','！','？','；','：','、','，','。','．','〈','〉','《','》','「','」','『','』','（','）','［','］','｛','｝','【','】','—','…','～','﹏','﹋','﹌','﹍','﹎','﹏','﹐','﹑','﹒','﹔','﹕','﹖','﹗','﹘','﹙','﹚','﹛','﹜','﹝','﹞','﹟','﹠','﹡','﹢','﹣','﹤',']']

def clean_find(text, sub_string):
    if not sub_string:
        return len(text)
    cleaned_sub_string = [ch for ch in sub_string if not is_whitespace_or_punctuation(ch)]
    cleaned_sub_string = cleaned_sub_string[:10]
    j = len(cleaned_sub_string) - 1  
    for i in range(len(text)-1, -1, -1):
        ch1 = text[i]
        if is_whitespace_or_punctuation(ch1):
            continue
        if ch1 == cleaned_sub_string[j]:
            if j == 0:
                return i
            j -= 1
        else:
            j = len(cleaned_sub_string) - 1
    return -1





def process_script(script_folder :str, script_file_name:str, script_processed_folder:str):
    with open(script_folder + "/" + script_file_name, 'r') as file1:
        txt = file1.read()

    chunk_index = 0
    chunk_size = 2048

    file2 = open( script_processed_folder + '/' + script_file_name, 'w')
    while chunk_index < len(txt):
#        chunk = get_text_chunk_test()
#        processed_chunk = process_text_chunk_test(chunk)  
        print(f'processing {script_file_name} {chunk_index}')

        chunk = txt[chunk_index: chunk_index + chunk_size]
        processed_chunk = process_text_chunk(chunk)  

        if chunk_index + chunk_size < len(txt):
            last_para_indx = processed_chunk.rfind('\n') 
            last_para = processed_chunk[last_para_indx+1:]
            in_chunk_indx = clean_find(chunk, last_para) 
            processed_chunk_cut = processed_chunk[:last_para_indx]
            chunk_index += in_chunk_indx
        else:
            chunk_index = len(txt)
            processed_chunk_cut = processed_chunk

        file2.write( processed_chunk_cut)
        file2.flush()

    file2.close()

def get_text_chunk_test():
    return """第三呢?那個羅曼密伯三呢?因信得救,來兼顧律法,這件事我要解釋了,以前,我必須要今天,我必須要說,我必須要說,我必須要說,我必須要說,我必須要說,我必須要說,我必須要說,我必須要說,我必須要說,我必須要說,我必須要說,我必須要說,我必須要說,我必須要說,我必須要說,我必� 就變成我今天的講題,關於約的問題,所以我現在把這拿掉,我可以坐下來,我先把這個關掉,來找出我要講的東西,就是這個,看遠問題,這個觀念沒有講清楚,沒有辦法解釋,我這個羅曼密伯三呢? 因信得救,兼顧律法,什麼意思?要講,要解釋這一點呢?必須要看這個,看這個東西,因為聖經就強調很重要的約,神革面立約是什麼呢?神革面立約,就是來表述他的信使,我革面立約,幫助你了解,我願意恩典給你,只要你們遵守我的條例,我赦免你們的罪,我赦免你們的罪,我赦免你們的罪,我赦免你們的罪,我赦免你們的罪,我赦免你們的罪,我赦免你們的罪,我赦免你們的罪,我赦免你們的罪,我赦免你們的罪,我赦免你們的罪,我赦 很重要,可是呢,你看啊,約,其實古時候,講約,看的,不是,說是約,有三種約,第一種約,希臘,就是這個,這個,很重要,這個我們要把它放大, 好,約,有種約,就是純粹給,純粹給合同,合同是什麼?兩個對方站在平等的地位上,來互相討價還價,來討論條件,我給你儲草,我給你割草,你每次給我二十五塊,或者每次給我三十塊,反正大家談談,談完之後呢,好了,決定了,就寫合同,right? 第二種,就diatheque,為移民,其實就是移族,古時候,所謂移民就是移族,diatheque,可是第三種,就是聖經所說的,belief,這個西班牙文,belief,這個belief是什麼?宗族國附庸國當中的約,宗族國附庸國當中的約,那現在是什麼呢? 純粹給,合同是什麼?好,立約的雙方呢,站在同等的地位,A跟B站在同等的地位,彼此討價還價,以求同意,同意之後立約,這個就是純粹給,合同。 第二種是什麼?diatheque,diatheque是什麼?中國把它換成移民,其實就是移族,那是什麼?那個就是移族,立移族的人,應許我死掉以後,我這個財產全部給你,或者一半給你,一半給誰,條件緊迫。 可是這個應許,這個條件,是由那個立移民的人來決定,可是belief是什麼?belief,宗族國附庸國當中的約,我等一下跟各位講這個內容到底是什麼,什麼叫宗族國附庸國的約,可是非常可惜,非常可惜。 我跟你講,宗族國跟附庸國的約,宗族國先恩戴附庸國,我決定,宗族國決定我要恩戴你,然後呢,宗族國對附庸國有所要求,我決定要恩戴你,我恩戴你以後,我說好。 我要恩戴你,所以我們要繼續維持跟你的關係,就好像比如說,現在我聽說,我在網路上看到,現在美國准許台灣一直想要向美國買F16,是可以拿來當戰鬥機。 那,美國最初不肯,他不肯賣,現在川普說可以考慮,可以考慮賣給你,可是什麼呢?好,賣給你。要不要賣?是美國主權決定,我就不賣給你,你要我就不賣給你,有什麼辦法? 可是呢,美國賣給他之後,就要講,就好像最近好像是在華盛頓一個國家,一個國家,大概是可能是印度跟那個叫做帕基斯坦的樣子,有七年空戰,戰爭對不對? 那其實美國好像把一架F16賣給帕基斯坦的樣子,空戰的時候,帕基斯坦就用那架F16去打擊,打印度的飛機,把他打下來。 現在美國很生氣,我賣給你,跟你講條件,我恩戴你,我給你條件之後,F16不能夠拿來打印度,帕基斯坦打印度好,可是他現在違背,不遵守美國的要求,美國現在很生氣,現在要處理他們的問題。 所以現在很差,你把印度的飛機打下來,那架F16,現在差這麼多,你覺得我怎麼樣我不知道,有時候我休息的時候就看看那個,有時候消息就是這樣子。 你看,非常重要,這個非常重要。然後中指揮國,現在恩戴傅永國之後,中指揮國對傅永國有所要求,這個非常重要。傅永國若遵守中指揮國的要求,你看很重要。 傅永國若遵守這個要求,怎麼樣,非常重要,不能建立好關係。你不說我要跟你建立好關係,中指揮國說我要跟你建立好關係,中指揮國說我才不要跟你建立好關係,我才不要把東西給你。 所以很清楚,這一點非常重要,不能建立好關係,這個非常重要。傅永國若遵守這個要求,不能建立好關係,那有什麼?傅永國若遵守這個要求,只能維持既有的好關係。 這兩個非常重要,我用黃色打的那兩步,非常重要。我本來想用紅色打出來,可是後來很重要,可是我想起來,原來不行,因為我的電腦是好電腦,我用紅色打出來就變紅了。 可是好電腦拖延出來之後,不是我的電腦的問題,不是開玩笑講的,可能是那個拖延器的問題,紅色就變成看不見,所以我就把它改成黃色,其實很重要。 其實這個東西我自己檢驗出來,奇怪,我每次用紅的打出來,學生告訴我說看不太清楚,奇怪,為什麼?所以我說不要罵,罵我的電腦,我的電腦是IBM的,不是,不是IBM的,是Macintosh,還不錯,我用了大概十幾年,還在用。 很重要,附庸我若遵守要求,不能建立好關係,只能夠維持既有的好關係"""


def process_text_chunk_test(chunk):
    return """第三呢？那個羅曼密伯三呢？因信得救,來兼顧律法，這件事我要解釋了。以前，我必須要今天，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說，我必須要說。這就變成我今天的講題，關於約的問題。

所以我現在把這拿掉，我可以坐下來，我先把這個關掉，來找出我要講的東西，就是這個，看遠問題，這個觀念沒有講清楚，沒有辦法解釋。我這個羅曼密伯三呢？因信得救，兼顧律法，什麼意思？要講，要解釋這一點呢？必須要看這個，看這個東西，因為聖經就強調很重要的約，神革面立約是什麼呢？

神革面立約，就是來表述他的信使，我革面立約，幫助你了解，我願意恩典給你，只要你們遵守我的條例，我赦免你們的罪，我赦免你們的罪，我赦免你們的罪，我赦免你們的罪，我赦免你們的罪，我赦免你們的罪，我赦免你們的罪，我赦免你們的罪，我赦免你們的罪，我赦免你們的罪，我赦免你們的罪，我赦免你們的罪。這很重要。

可是呢，你看啊，約，其實古時候，講約，看的，不是，說是約，有三種約。第一種約，希臘，就是這個，這個，很重要，這個我們要把它放大。好，約，有種約，就是純粹給，純粹給合同，合同是什麼？兩個對方站在平等的地位上，來互相討價還價，來討論條件，我給你儲草，我給你割草，你每次給我二十五塊，或者每次給我三十塊，反正大家談談，談完之後呢，好了，決定了，就寫合同，right？

第二種，就diatheque，為移民，其實就是移族，古時候，所謂移民就是移族，diatheque。可是第三種，就是聖經所說的，belief，這個西班牙文，belief，這個belief是什麼？宗族國附庸國當中的約，宗族國附庸國當中的約，那現在是什麼呢？

純粹給，合同是什麼？好，立約的雙方呢，站在同等的地位，A跟B站在同等的地位，彼此討價還價，以求同意，同意之後立約，這個就是純粹給，合同。

第二種是什麼？diatheque，diatheque是什麼？中國把它換成移民，其實就是移族，那是什麼？那個就是移族，立移族的人，應許我死掉以後，我這個財產全部給你，或者一半給你，一半給誰，條件緊迫。可是這個應許，這個條件，是由那個立移民的人來決定。

可是belief是什麼？belief，宗族國附庸國當中的約，我等一下跟各位講這個內容到底是什麼，什麼叫宗族國附庸國的約，可是非常可惜，非常可惜。

我跟你講，宗族國跟附庸國的約，宗族國先恩戴附庸國，我決定，宗族國決定我要恩戴你，然後呢，宗族國對附庸國有所要求，我決定要恩戴你，我恩戴你以後，我說好。我要恩戴你，所以我們要繼續維持跟你的關係，就好像比如說，現在我聽說，我在網路上看到，現在美國准許台灣一直想要向美國買F16，是可以拿來當戰鬥機。

那，美國最初不肯，他不肯賣，現在川普說可以考慮，可以考慮賣給你，可是什麼呢？好，賣給你。要不要賣？是美國主權決定，我就不賣給你，你要我就不賣給你，有什麼辦法？

可是呢，美國賣給他之後，就要講，就好像最近好像是在華盛頓一個國家，一個國家，大概是可能是印度跟那個叫做帕基斯坦的樣子，有七年空戰，戰爭對不對？那其實美國好像把一架F16賣給帕基斯坦的樣子，空戰的時候，帕基斯坦就用那架F16去打擊，打印度的飛機，把他打下來。

現在美國很生氣，我賣給你，跟你講條件，我恩戴你，我給你條件之後，F16不能夠拿來打印度，帕基斯坦打印度好，可是他現在違背，不遵守美國的要求，美國現在很生氣，現在要處理他們的問題。所以現在很差，你把印度的飛機打下來，那架F16，現在差這麼多，你覺得我怎麼樣我不知道，有時候我休息的時候就看看那個，有時候消息就是這樣子。

你看，非常重要，這個非常重要。然後中指揮國，現在恩戴傅永國之後，中指揮國對傅永國有所要求，這個非常重要。傅永國若遵守中指揮國的要求，你看很重要。傅永國若遵守這個要求，怎麼樣，非常重要，不能建立好關係。

你不說我要跟你建立好關係，中指揮國說我要跟你建立好關係，中指揮國說我才不要跟你建立好關係，我才不要把東西給你。所以很清楚，這一點非常重要，不能建立好關係，這個非常重要。傅永國若遵守這個要求，不能建立好關係，那有什麼？傅永國若遵守這個要求，只能維持既有的好關係。

這兩個非常重要，我用黃色打的那兩步，非常重要。我本來想用紅色打出來，可是後來很重要，可是我想起來，原來不行，因為我的電腦是好電腦，我用紅色打出來就變紅了。可是好電腦拖延出來之後，不是我的電腦的問題，不是開玩笑講的，可能是那個拖延器的問題，紅色就變成看不見，所以我就把它改成黃色，其實很重要。

其實這個東西我自己檢驗出來，奇怪，我每次用紅的打出來，學生告訴我說看不太清楚，奇怪，為什麼？所以我說不要罵，罵我的電腦，我的電腦是IBM的，不是，不是IBM的，是Macintosh，還不錯，我用了大概十幾年，還在用。

很重要，附庸我若遵守要求，不能建立好關係，只能夠維持既有的好關係。"""



def process_text_chunk(chunk):
    response = openai.chat.completions.create(
            model="gpt-4",
            messages=[{"role": "user", "content": f"给下面基督教牧师的讲道加标点，分段落.其他不要改动\n\n{chunk}"}],
            temperature=0.5,
            max_tokens=4000,
            top_p=1.0,
            frequency_penalty=0.0,
            presence_penalty=0.0,
            stream=True
        )
    print('generating response ...')
    processed_chunk = ''
    for ch in response:
        delta_content = ch.choices[0].delta.content
#        print(delta_content, end='')
        if delta_content:
            processed_chunk += delta_content
    return processed_chunk

def process_all_script(script_file_path:str, script_processed_path:str ):
    script_files = get_files(script_file_path,'.txt')
    for script_file in script_files:
        if script_file in ['2019-2-15 心mp4.txt','2019-3-24 罗马书3章21至31节.txt']:
            continue
        process_script(script_file_path, script_file,script_processed_path )



process_all_script('/Users/junyang/church/data/script','/Users/junyang/church/data/script_processed')